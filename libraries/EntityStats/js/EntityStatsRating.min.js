class EntityStatsRating{get s(){return{trigger:".js-entity__rating",vote_class:"voted",timeout:1e3}}constructor(t){this.ctl=t,this.element=this.ctl.element.querySelector(this.s.trigger),this.status=!(!this.element||!this.ctl.statEnabled("rating")),this.count=this._getCount(),this.rating,this.rup=this.rdwn=null,this.classlist,this.id="entity-"+this.ctl.id+"-vote-result",this.vote_result=parseInt(localStorage.getItem(this.id)??0),this.voting_in_process=!1,this.voting_started=0}_getCount(){return this.status?parseInt(this.element.innerText):null}async init(){this._loadGui(),0!=this.vote_result&&await this._makeVote(0),this.status&&this._createVotingEvent()}_loadGui(){this._setClasslist(),this._createButtons(),this.rating=document.createElement("span");for(let t of this.classlist.suffix("-number"))this.rating.classList.add(t);this._setRatingNumber(this.count),this.element.innerHTML="",this.element.append(this.rdwn),this.element.append(this.rating),this.element.append(this.rup)}_setRatingNumber(t){t>=0?(t=t>0?"+"+t:t,this.rating.classList.contains("negative")&&this.rating.classList.remove("negative")):t<0&&(this.rating.classList.contains("negative")||this.rating.classList.add("negative")),this.rating.innerText=t}_setClasslist(){this.classlist=[];let t=new RegExp("^js-entity","i");for(let s=0;s<this.element.classList.length;s++)t.test(this.element.classList[s])||this.classlist.push(this.element.classList[s])}_createButtons(){let t='<svg><use href="/images/icons/thumbs.svg#svg-thumbs-icon"></use></svg>';this.rup=document.createElement("button");for(let t of this.classlist.suffix(["-btn","-btn_up"]))this.rup.classList.add(t);this.rup.innerHTML=t,this.rup.title="Vote up",this.rdwn=document.createElement("button");for(let t of this.classlist.suffix(["-btn","-btn_down"]))this.rdwn.classList.add(t);this.rdwn.innerHTML=t,this.rdwn.title="Vote down"}_setVotingClass(t){t<=0&&(this.rup.classList.contains(this.s.vote_class)&&this.rup.classList.remove(this.s.vote_class),t<0&&this.rdwn.classList.add(this.s.vote_class)),t>=0&&(this.rdwn.classList.contains(this.s.vote_class)&&this.rdwn.classList.remove(this.s.vote_class),t>0&&this.rup.classList.add(this.s.vote_class))}_createVotingEvent(){this.rup.addEventListener("click",(()=>{this.voting_in_process||this._makeVote(1)})),this.rdwn.addEventListener("click",(()=>{this.voting_in_process||this._makeVote(-1)}))}async _makeVote(t){if(t<0&&this.vote_result<0||t>0&&this.vote_result>0)return;let s=this.vote_result;this._lockVoting(),0!=t&&(this.vote_result+=t),await this._updateRating(t)||(this.vote_result=s),this._completeVoting()}async _updateRating(t){let s={argument:"rating",vote_result:this.vote_result},e=cookie.get("PHPSESSID"),i=localStorage.getItem(this.id+"-session");if(0!=t)s.increment=t;else if(e==i)return!1;let n=await this.ctl.makeRequest(s);return n&&(this.count+=t,this._setRatingNumber(this.count),localStorage.setItem(this.id+"-session",e),localStorage.setItem(this.id,this.vote_result)),n}_completeVoting(t=!1){let s=Date.now()-this.voting_started;s<this.s.timeout&&!t?setTimeout((()=>{this._completeVoting(!0)}),this.s.timeout-s):(this._setVotingClass(this.vote_result),this._clearVotingLockStatus())}_lockVoting(){this.voting_in_process=!0,this.voting_started=Date.now(),this.rup.setAttribute("disabled",null),this.rdwn.setAttribute("disabled",null)}_clearVotingLockStatus(){this.voting_started=0,this.voting_in_process=!1,this.rup.removeAttribute("disabled"),this.rdwn.removeAttribute("disabled")}}