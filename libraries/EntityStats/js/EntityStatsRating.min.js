class EntityStatsRating{get s(){return{trigger:".js-entity__rating",vote_class:"voted",timeout:1e3}}constructor(t){this.ctl=t,this.element=this.ctl.element.querySelector(this.s.trigger),this.status=!(!this.element||!this.ctl.statEnabled("rating")),this.count=this._getCount(),this.rating,this.rup=this.rdwn=null,this.classlist,this.id="entity-"+this.ctl.id+"-vote-result",this.vote_result=parseInt(localStorage.getItem(this.id)??0),this.voting_in_process=!1,this.voting_started=0}_getCount(){return this.status?parseInt(this.element.innerText):null}init(){this.status&&this._loadGui()}_loadGui(){this._setClasslist(),this._createButtons(),this.rating=document.createElement("span");for(let t of this.classlist.suffix("-number"))this.rating.classList.add(t);this._setRatingNumber(this.count),this.element.innerHTML="",this.element.append(this.rdwn),this.element.append(this.rating),this.element.append(this.rup),this._createVotingEvent()}_setRatingNumber(t){t>0&&(t="+"+t),this.rating.innerText=t}_setClasslist(){this.classlist=[];let t=new RegExp("^js-entity","i");for(let s=0;s<this.element.classList.length;s++)t.test(this.element.classList[s])||this.classlist.push(this.element.classList[s])}_createButtons(){this.rup=document.createElement("button");for(let t of this.classlist.suffix(["-btn","-btn_up"]))this.rup.classList.add(t);this.rup.innerText="+",this.rdwn=document.createElement("button");for(let t of this.classlist.suffix(["-btn","-btn_down"]))this.rdwn.classList.add(t);this.rdwn.innerText="-",this._setVotingClass(this.vote_result)}_setVotingClass(t){t<=0&&(this.rup.classList.contains(this.s.vote_class)&&this.rup.classList.remove(this.s.vote_class),t<0&&this.rdwn.classList.add(this.s.vote_class)),t>=0&&(this.rdwn.classList.contains(this.s.vote_class)&&this.rdwn.classList.remove(this.s.vote_class),t>0&&this.rup.classList.add(this.s.vote_class))}_createVotingEvent(){this.rup.addEventListener("click",(()=>{this.voting_in_process||this._makeVote(1)})),this.rdwn.addEventListener("click",(()=>{this.voting_in_process||this._makeVote(-1)}))}async _makeVote(t){t<0&&this.vote_result<0||t>0&&this.vote_result>0||(this._lockVoting(),(t>0||t<0)&&(this.vote_result+=t),this._setVotingClass(this.vote_result),await this._updateRating(t),localStorage.setItem(this.id,this.vote_result),this._completeVoting())}async _updateRating(t){this.count+=t,this._setRatingNumber(this.count);let s={fn:"update",key:"rating",increment:t};await this.ctl.makeRequest(s)}_completeVoting(){let t=Date.now()-this.voting_started;t<this.s.timeout?setTimeout((()=>{this._clearVotingLockStatus()}),this.s.timeout-t):this._clearVotingLockStatus()}_lockVoting(){this.voting_in_process=!0,this.voting_started=Date.now(),this.rup.setAttribute("disabled",null),this.rdwn.setAttribute("disabled",null)}_clearVotingLockStatus(){this.voting_started=0,this.voting_in_process=!1,this.rup.removeAttribute("disabled"),this.rdwn.removeAttribute("disabled")}}